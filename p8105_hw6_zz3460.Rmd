---
title: "p8105_hw6_zz3460"
author: "Zihan Zhou"
date: "2025-11-17"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Problem 1

Set seed and load key packages.

```{r}
set.seed(2025)

library(tidyverse)
library(broom)
library(purrr)
library(readr)
```

Read in data and clean.

```{r}
homi <- read_csv("data/homicide-data.csv")

homi_clean <- homi %>%
  mutate(
    city_state = paste(city, state, sep = ", "),
    disposition = str_trim(disposition),
    solved = if_else(disposition == "Closed by arrest", 1L, 0L),
    victim_age = as.numeric(victim_age),
    victim_race = str_to_title(str_trim(victim_race)),
    victim_sex = str_to_title(str_trim(victim_sex))
  ) %>%
  filter(
    !(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")),  # drop specified cities
    victim_race %in% c("White", "Black")                                               # keep only white/black
  )

glimpse(homi_clean)
count(homi_clean, city_state) %>% arrange(desc(n)) %>% head()
```

Fit a logistic regression for Baltimore.

```{r}
baltimore <- homi_clean %>% filter(city_state == "Baltimore, MD")

baltimore <- baltimore %>%
  mutate(victim_sex = factor(victim_sex, levels = c("Female", "Male")),
         victim_race = factor(victim_race)) 

balt_model <- glm(solved ~ victim_age + victim_sex + victim_race, data = baltimore, family = binomial())
balt_tidy <- tidy(balt_model, conf.int = TRUE, exponentiate = TRUE)

# pull the Male vs Female OR row (handle case term name might differ by dataset)
balt_OR_row <- balt_tidy %>% filter(term %in% c("victim_sexMale", "victim_sexMale"))
balt_OR_row
```

Fit models by city robustly, extract OR and CI for male vs female

```{r}
city_summary <- homi_clean %>%
  group_by(city_state) %>%
  summarise(n = n(), sexes = n_distinct(victim_sex), .groups = "drop") %>%
  filter(n >= 10, sexes >= 2)

cities <- city_summary$city_state

models_by_city <- homi_clean %>%
  filter(city_state %in% cities) %>%
  group_by(city_state) %>%
  nest() %>%
  mutate(
    data = map(data, ~ .x %>% mutate(victim_sex = factor(victim_sex, levels = c("Female","Male")),
                                     victim_race = factor(victim_race)) ),
    model = map(data, ~ tryCatch(glm(solved ~ victim_age + victim_sex + victim_race, data = .x, family = binomial()), error = function(e) NULL)),
    tidy = map(model, ~ if (is.null(.x)) tibble(term=NA, estimate=NA, std.error=NA, statistic=NA, p.value=NA, conf.low=NA, conf.high=NA) else tidy(.x, conf.int = TRUE, exponentiate = TRUE))
  ) %>%
  select(city_state, tidy) %>%
  unnest(tidy)

# pull male vs female rows and arrange
or_by_city <- models_by_city %>%
  filter(term == "victim_sexMale") %>%
  select(city_state, estimate, conf.low, conf.high, p.value) %>%
  arrange(estimate)

# plot (English labels for Rmd)
or_by_city %>%
  mutate(city_state = fct_reorder(city_state, estimate)) %>%
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  coord_flip() +
  labs(title = "Adjusted OR for Solving Homicide (Male vs Female)", x = "City", y = "Odds Ratio (Male vs Female)") +
  theme_minimal(base_size = 12)
```


## Problem 2

Read in data and clean.

```{r}
library(p8105.datasets)
data("weather_df")
wd <- weather_df %>% select(tmax, tmin, prcp) %>% drop_na()

```

Bootstrap

```{r}
set.seed(2025)
B <- 5000
boot_results <- map_dfr(seq_len(B), function(i) {
  samp <- sample_n(wd, size = nrow(wd), replace = TRUE)
  fit <- lm(tmax ~ tmin + prcp, data = samp)
  r2 <- glance(fit)$r.squared
  td <- tidy(fit)
  beta_tmin <- td %>% filter(term == "tmin") %>% pull(estimate)
  beta_prcp <- td %>% filter(term == "prcp") %>% pull(estimate)
  tibble(r2 = r2, beta_prod = beta_tmin * beta_prcp)
})

```

Distribution and CI

```{r}
r2_CI <- quantile(boot_results$r2, c(0.025, 0.975))
beta_prod_CI <- quantile(boot_results$beta_prod, c(0.025, 0.975))

ggplot(boot_results, aes(r2)) + geom_histogram(bins = 40) + labs(title = "Bootstrap distribution of R-squared")
ggplot(boot_results, aes(beta_prod)) + geom_histogram(bins = 40) + labs(title = "Bootstrap distribution of beta1 * beta2")

r2_CI
beta_prod_CI
```

