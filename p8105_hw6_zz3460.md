p8105_hw6_zz3460
================
Zihan Zhou
2025-11-17

## Problem 1

Set seed and load key packages.

``` r
set.seed(2025)

library(tidyverse)
```

    ## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
    ## ✔ dplyr     1.1.4     ✔ readr     2.1.5
    ## ✔ forcats   1.0.0     ✔ stringr   1.6.0
    ## ✔ ggplot2   4.0.0     ✔ tibble    3.3.0
    ## ✔ lubridate 1.9.4     ✔ tidyr     1.3.1
    ## ✔ purrr     1.2.0     
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()
    ## ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors

``` r
library(broom)
library(purrr)
library(readr)
```

Read in data and clean.

``` r
homi <- read_csv("data/homicide-data.csv")
```

    ## Rows: 52179 Columns: 12
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (9): uid, victim_last, victim_first, victim_race, victim_age, victim_sex...
    ## dbl (3): reported_date, lat, lon
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
homi_clean <- homi %>%
  mutate(
    city_state = paste(city, state, sep = ", "),
    disposition = str_trim(disposition),
    solved = if_else(disposition == "Closed by arrest", 1L, 0L),
    victim_age = as.numeric(victim_age),
    victim_race = str_to_title(str_trim(victim_race)),
    victim_sex = str_to_title(str_trim(victim_sex))
  ) %>%
  filter(
    !(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")),  # drop specified cities
    victim_race %in% c("White", "Black")                                               # keep only white/black
  )
```

    ## Warning: There was 1 warning in `mutate()`.
    ## ℹ In argument: `victim_age = as.numeric(victim_age)`.
    ## Caused by warning:
    ## ! NAs introduced by coercion

``` r
glimpse(homi_clean)
```

    ## Rows: 39,693
    ## Columns: 14
    ## $ uid           <chr> "Alb-000003", "Alb-000005", "Alb-000006", "Alb-000009", …
    ## $ reported_date <dbl> 20100601, 20100102, 20100126, 20100130, 20100218, 201003…
    ## $ victim_last   <chr> "SATTERFIELD", "MULA", "BOOK", "MARTIN-LEYVA", "LUJAN", …
    ## $ victim_first  <chr> "VIVIANA", "VIVIAN", "GERALDINE", "GUSTAVO", "KEVIN", "S…
    ## $ victim_race   <chr> "White", "White", "White", "White", "White", "White", "W…
    ## $ victim_age    <dbl> 15, 72, 91, 56, NA, 43, 52, 22, 15, 25, 20, 88, 36, 47, …
    ## $ victim_sex    <chr> "Female", "Female", "Female", "Male", "Male", "Female", …
    ## $ city          <chr> "Albuquerque", "Albuquerque", "Albuquerque", "Albuquerqu…
    ## $ state         <chr> "NM", "NM", "NM", "NM", "NM", "NM", "NM", "NM", "NM", "N…
    ## $ lat           <dbl> 35.08609, 35.13036, 35.15111, 35.07538, 35.07701, 35.070…
    ## $ lon           <dbl> -106.6956, -106.5810, -106.5378, -106.5535, -106.5649, -…
    ## $ disposition   <chr> "Closed without arrest", "Closed without arrest", "Open/…
    ## $ city_state    <chr> "Albuquerque, NM", "Albuquerque, NM", "Albuquerque, NM",…
    ## $ solved        <int> 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1,…

``` r
count(homi_clean, city_state) %>% arrange(desc(n)) %>% head()
```

    ## # A tibble: 6 × 2
    ##   city_state           n
    ##   <chr>            <int>
    ## 1 Chicago, IL       4507
    ## 2 Baltimore, MD     2753
    ## 3 Philadelphia, PA  2615
    ## 4 Detroit, MI       2457
    ## 5 Houston, TX       1887
    ## 6 St. Louis, MO     1645

Fit a logistic regression for Baltimore.

``` r
baltimore <- homi_clean %>% filter(city_state == "Baltimore, MD")

baltimore <- baltimore %>%
  mutate(victim_sex = factor(victim_sex, levels = c("Female", "Male")),
         victim_race = factor(victim_race)) 

balt_model <- glm(solved ~ victim_age + victim_sex + victim_race, data = baltimore, family = binomial())
balt_tidy <- tidy(balt_model, conf.int = TRUE, exponentiate = TRUE)

# pull the Male vs Female OR row (handle case term name might differ by dataset)
balt_OR_row <- balt_tidy %>% filter(term %in% c("victim_sexMale", "victim_sexMale"))
balt_OR_row
```

    ## # A tibble: 1 × 7
    ##   term           estimate std.error statistic  p.value conf.low conf.high
    ##   <chr>             <dbl>     <dbl>     <dbl>    <dbl>    <dbl>     <dbl>
    ## 1 victim_sexMale    0.426     0.138     -6.18 6.26e-10    0.324     0.558

Fit models by city robustly, extract OR and CI for male vs female

``` r
city_summary <- homi_clean %>%
  group_by(city_state) %>%
  summarise(n = n(), sexes = n_distinct(victim_sex), .groups = "drop") %>%
  filter(n >= 10, sexes >= 2)

cities <- city_summary$city_state

models_by_city <- homi_clean %>%
  filter(city_state %in% cities) %>%
  group_by(city_state) %>%
  nest() %>%
  mutate(
    data = map(data, ~ .x %>% mutate(victim_sex = factor(victim_sex, levels = c("Female","Male")),
                                     victim_race = factor(victim_race)) ),
    model = map(data, ~ tryCatch(glm(solved ~ victim_age + victim_sex + victim_race, data = .x, family = binomial()), error = function(e) NULL)),
    tidy = map(model, ~ if (is.null(.x)) tibble(term=NA, estimate=NA, std.error=NA, statistic=NA, p.value=NA, conf.low=NA, conf.high=NA) else tidy(.x, conf.int = TRUE, exponentiate = TRUE))
  ) %>%
  select(city_state, tidy) %>%
  unnest(tidy)

# pull male vs female rows and arrange
or_by_city <- models_by_city %>%
  filter(term == "victim_sexMale") %>%
  select(city_state, estimate, conf.low, conf.high, p.value) %>%
  arrange(estimate)

# plot (English labels for Rmd)
or_by_city %>%
  mutate(city_state = fct_reorder(city_state, estimate)) %>%
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  coord_flip() +
  labs(title = "Adjusted OR for Solving Homicide (Male vs Female)", x = "City", y = "Odds Ratio (Male vs Female)") +
  theme_minimal(base_size = 12)
```

![](p8105_hw6_zz3460_files/figure-gfm/unnamed-chunk-4-1.png)<!-- -->

## Problem 2

Read in data and clean.

``` r
library(p8105.datasets)
data("weather_df")
wd <- weather_df %>% select(tmax, tmin, prcp) %>% drop_na()
```

Bootstrap

``` r
set.seed(2025)
B <- 5000
boot_results <- map_dfr(seq_len(B), function(i) {
  samp <- sample_n(wd, size = nrow(wd), replace = TRUE)
  fit <- lm(tmax ~ tmin + prcp, data = samp)
  r2 <- glance(fit)$r.squared
  td <- tidy(fit)
  beta_tmin <- td %>% filter(term == "tmin") %>% pull(estimate)
  beta_prcp <- td %>% filter(term == "prcp") %>% pull(estimate)
  tibble(r2 = r2, beta_prod = beta_tmin * beta_prcp)
})
```

Distribution and CI

``` r
r2_CI <- quantile(boot_results$r2, c(0.025, 0.975))
beta_prod_CI <- quantile(boot_results$beta_prod, c(0.025, 0.975))

ggplot(boot_results, aes(r2)) + geom_histogram(bins = 40) + labs(title = "Bootstrap distribution of R-squared")
```

![](p8105_hw6_zz3460_files/figure-gfm/unnamed-chunk-7-1.png)<!-- -->

``` r
ggplot(boot_results, aes(beta_prod)) + geom_histogram(bins = 40) + labs(title = "Bootstrap distribution of beta1 * beta2")
```

![](p8105_hw6_zz3460_files/figure-gfm/unnamed-chunk-7-2.png)<!-- -->

``` r
r2_CI
```

    ##      2.5%     97.5% 
    ## 0.9341324 0.9465590

``` r
beta_prod_CI
```

    ##         2.5%        97.5% 
    ## -0.008268478 -0.003748858

## Problem 3

Load and clean the data.

``` r
bw <- read_csv("data/birthweight.csv")
```

    ## Rows: 4342 Columns: 20
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (20): babysex, bhead, blength, bwt, delwt, fincome, frace, gaweeks, malf...
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
bw_clean <- bw %>%
  mutate(
    babysex = factor(babysex, levels = c(1,2), labels = c("male","female")),
    frace = factor(frace), mrace = factor(mrace), malform = factor(malform)
  ) %>%
  # keep rows with essential vars non-missing for modeling
  filter(!is.na(bwt), !is.na(blength), !is.na(bhead), !is.na(gaweeks))
```
